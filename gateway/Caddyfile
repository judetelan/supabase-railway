{
    auto_https off
    admin off
}

:{$PORT:8080} {
    # Health check (no auth required)
    respond /health "OK" 200

    # CORS headers
    header {
        Access-Control-Allow-Origin {$CORS_ORIGIN:*}
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Access-Control-Allow-Headers "Authorization, Content-Type, apikey, x-client-info, x-request-id, x-supabase-api-version, prefer, x-upsert, range, accept-profile, content-profile"
        Access-Control-Expose-Headers "content-range, x-supabase-api-version"
    }

    # OPTIONS preflight
    @options method OPTIONS
    respond @options "" 204

    # Auth routes
    route /auth/v1* {
        uri strip_prefix /auth/v1
        reverse_proxy {$AUTH_HOST}:443 {
            header_up Host {$AUTH_HOST}
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Methods
            header_down -Access-Control-Allow-Headers
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Expose-Headers
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # REST routes
    route /rest/v1* {
        uri strip_prefix /rest/v1
        reverse_proxy {$REST_HOST}:443 {
            header_up Host {$REST_HOST}
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Methods
            header_down -Access-Control-Allow-Headers
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Expose-Headers
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Storage routes
    route /storage/v1* {
        uri strip_prefix /storage/v1
        reverse_proxy {$STORAGE_HOST}:443 {
            header_up Host {$STORAGE_HOST}
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Methods
            header_down -Access-Control-Allow-Headers
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Expose-Headers
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Edge Functions routes
    route /functions/v1* {
        reverse_proxy {$FUNCTIONS_HOST}:443 {
            header_up Host {$FUNCTIONS_HOST}
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Methods
            header_down -Access-Control-Allow-Headers
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Expose-Headers
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Realtime routes
    route /realtime/v1* {
        uri strip_prefix /realtime/v1
        reverse_proxy {$REALTIME_HOST}:443 {
            header_up Host {$REALTIME_HOST}
            header_down -Access-Control-Allow-Origin
            header_down -Access-Control-Allow-Methods
            header_down -Access-Control-Allow-Headers
            header_down -Access-Control-Allow-Credentials
            header_down -Access-Control-Expose-Headers
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Default response
    respond `{"service":"supabase-gateway","status":"ok","endpoints":["/auth/v1","/rest/v1","/storage/v1","/functions/v1","/pg","/realtime/v1"]}` 200
}
