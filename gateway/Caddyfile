{
    auto_https off
    admin off
}

:{$PORT:8080} {
    # Health check (no auth required)
    respond /health "OK" 200

    # CORS headers - Use environment variable for allowed origins
    # Set CORS_ORIGIN to your frontend domain, e.g., "https://myapp.com"
    # Use "*" only for development
    header {
        Access-Control-Allow-Origin {$CORS_ORIGIN:*}
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS, PATCH"
        Access-Control-Allow-Headers "Authorization, Content-Type, apikey, x-client-info, x-request-id, x-supabase-api-version, prefer, x-upsert, range, accept-profile, content-profile"
        Access-Control-Allow-Credentials "true"
        Access-Control-Expose-Headers "content-range, x-supabase-api-version"
    }

    # Studio routes - Protected with Basic Auth
    # Username: jude | Password: 143668
    route /studio* {
        basic_auth {
            jude $2b$14$koB6w9O8gLnnREfMdnRe0uHEcfWtMf2M9jspuz/ruIUfauyAOB9Uy
        }
        reverse_proxy supabase-studio-production-daa2.up.railway.app:443 {
            header_up Host supabase-studio-production-daa2.up.railway.app
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # OPTIONS preflight
    @options method OPTIONS
    respond @options "" 204

    # Auth routes - match anything starting with /auth/v1
    route /auth/v1* {
        uri strip_prefix /auth/v1
        reverse_proxy supabase-auth-production-c390.up.railway.app:443 {
            header_up Host supabase-auth-production-c390.up.railway.app
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # REST routes
    route /rest/v1* {
        uri strip_prefix /rest/v1
        reverse_proxy supabase-rest-production.up.railway.app:443 {
            header_up Host supabase-rest-production.up.railway.app
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Storage routes
    route /storage/v1* {
        uri strip_prefix /storage/v1
        reverse_proxy supabase-storage-production-cfd8.up.railway.app:443 {
            header_up Host supabase-storage-production-cfd8.up.railway.app
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Edge Functions routes
    route /functions/v1* {
        reverse_proxy supabase-edge-functions-production.up.railway.app:443 {
            header_up Host supabase-edge-functions-production.up.railway.app
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Realtime routes
    route /realtime/v1* {
        uri strip_prefix /realtime/v1
        reverse_proxy supabase-realtime-production-8f0e.up.railway.app:443 {
            header_up Host supabase-realtime-production-8f0e.up.railway.app
            transport http {
                tls
                tls_insecure_skip_verify
            }
        }
    }

    # Default response
    respond `{"service":"supabase-gateway","status":"ok","endpoints":["/auth/v1","/rest/v1","/storage/v1","/functions/v1","/pg","/realtime/v1"]}` 200
}
